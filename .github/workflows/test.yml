name: Verify and Test TinyTeX on Windows

on: [push]

jobs:
  test-on-windows:
    runs-on: windows-latest
    
    steps:
    # --- 第一步：精简验证 ---
    - name: 1. 验明正身
      run: |
        Write-Host "正在检查运行环境..."
        if (Test-Path "C:\") {
            Write-Host "验证通过：检测到 C 盘，确认是 Windows 环境。"
        } else {
            throw "验证失败：未检测到 C 盘！"
        }

    # --- 第二步：创建测试文件 (关键修改) ---
    - name: 2. 创建测试用 LaTeX 文件
      run: |
        # 注意：这里增加了 [fontset=fandol] 选项
        # 这告诉 ctex 不要找系统字体，而是使用自带的 Fandol 字体，从而兼容无字体的服务器环境
        $texContent = @"
        \documentclass{beamer}
        \usepackage[fontset=fandol]{ctex} 
        \usepackage{tikz}
        \begin{document}
        \begin{frame}{测试成功}
        \begin{center}
            \begin{tikzpicture}\draw[fill=green](0,0)circle(1.5);\node at(0,0){\Huge 中文}; \end{tikzpicture}
            \\
            TinyTeX on Windows GitHub Actions 验证成功！
        \end{center}
        \end{frame}
        \end{document}
        "@
        Set-Content -Path test.tex -Value $texContent -Encoding UTF8

    # --- 第三步：安装 TinyTeX ---
    - name: 3. 安装 TinyTeX
      shell: cmd
      run: |
        curl -sL "https://yihui.org/tinytex/install-bin-windows.bat" -o install.bat
        install.bat

    # --- 第四步：配置环境变量 ---
    - name: 4. 添加到系统路径
      run: |
        echo "$env:APPDATA\TinyTeX\bin\windows" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    # --- 第五步：安装缺失宏包 (关键修改) ---
    - name: 5. 安装中文与绘图支持
      # 注意：这里增加了 fandol 包，这是开源中文字体
      run: tlmgr install ctex xecjk beamer pgf ms gbt7714 fandol

    # --- 第六步：编译测试 ---
    - name: 6. 编译 PDF
      run: xelatex -interaction=nonstopmode test.tex

    # --- 第七步：上传结果 ---
    - name: 7. 上传 PDF 结果
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: test-result-pdf
        path: test.pdf