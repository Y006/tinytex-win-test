name: Verify and Test TinyTeX on Windows

on: workflow_dispatch

jobs:
  test-on-windows:
    runs-on: windows-latest
    
    steps:
    # --- 第一步：精简验证 ---
    - name: 1. 验明正身
      run: |
        Write-Host "正在检查运行环境..."
        if (Test-Path "C:\") {
            Write-Host "验证通过：检测到 C 盘，确认是 Windows 环境。"
        } else {
            throw "验证失败：未检测到 C 盘！"
        }

    # --- 第二步：创建测试文件 (修改：增加读取日志的功能) ---
    - name: 2. 创建测试用 LaTeX 文件
      run: |
        # 我们增加了 veramtin 宏包，并在后面使用 \verbatiminput{packages.txt} 读取日志
        $texContent = @"
        \documentclass{beamer}
        \usepackage[fontset=fandol]{ctex} 
        \usepackage{tikz}
        \usepackage{verbatim} % 关键：用于读取外部文本文件

        \begin{document}
        
        \begin{frame}{测试成功}
        \begin{center}
            \begin{tikzpicture}\draw[fill=green](0,0)circle(1.5);\node at(0,0){\Huge 中文}; \end{tikzpicture}
            \\
            TinyTeX on Windows GitHub Actions 验证成功！
        \end{center}
        \end{frame}

        % --- 新增：显示包列表 ---
        % allowframebreaks 允许内容太长自动分页
        \begin{frame}[allowframebreaks]{当前环境已安装宏包清单}
            \tiny % 使用极小字体以容纳更多内容
            % 直接读取由 PowerShell 生成的 packages.txt 文件
            \verbatiminput{packages.txt}
        \end{frame}

        \end{document}
        "@
        Set-Content -Path test.tex -Value $texContent -Encoding UTF8

    # --- 第三步：安装 TinyTeX ---
    - name: 3. 安装 TinyTeX
      shell: cmd
      run: |
        curl -sL "https://yihui.org/tinytex/install-bin-windows.bat" -o install.bat
        install.bat

    # --- 第四步：配置环境变量 ---
    - name: 4. 添加到系统路径
      run: |
        echo "$env:APPDATA\TinyTeX\bin\windows" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    # --- 第五步：安装缺失宏包 ---
    - name: 5. 安装中文与绘图支持
      # 修改：增加了 tools 包 (为了支持 verbatim 宏包)
      run: tlmgr install ctex xecjk beamer pgf ms gbt7714 fandol tools

    # --- 【新增步骤】：生成包列表日志 ---
    - name: 5.5 生成已安装包清单
      run: |
        Write-Host "正在导出已安装包列表..."
        # 将 tlmgr 的输出重定向到 packages.txt，并指定 UTF8 编码防止 LaTeX 读取乱码
        tlmgr list --only-installed | Out-File -FilePath packages.txt -Encoding utf8
        
        # 打印一下看看 (可选，方便在 Action 日志里调试)
        Get-Content packages.txt -TotalCount 5

    # --- 第六步：编译测试 ---
    - name: 6. 编译 PDF
      run: xelatex -interaction=nonstopmode test.tex

    # --- 第七步：上传结果 ---
    - name: 7. 上传 PDF 结果
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: test-result-with-log
        path: test.pdf