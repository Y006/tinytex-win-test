name: Modular TinyTeX Build

on: workflow_dispatch

jobs:
  build-and-test:
    runs-on: windows-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    # 【修复】将中文验证日志改为英文，防止 PowerShell 乱码报错
    - name: Verify Windows Environment
      shell: powershell
      run: |
        Write-Host "Step 1: Verifying OS Environment..."
        
        Write-Host "OS Core: $env:OS"
        if ($env:OS -ne "Windows_NT") { 
            throw "Error: This is NOT a Windows machine!" 
        }
        
        if (-not (Test-Path "C:\")) { 
            throw "Error: C Drive not found!" 
        }
        
        Write-Host "Success: Windows Server Environment Verified."

    # 调用脚本
    - name: Run Install Script
      shell: powershell
      run: .\install-tinytex.ps1

    # 编译
    - name: Compile PDF
      run: xelatex -interaction=nonstopmode test.tex

    # 上传
    - name: Upload Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: final-report
        path: test.pdf