name: Modular TinyTeX Build

# 手动触发
on: workflow_dispatch

jobs:
  build-and-test:
    runs-on: windows-latest
    
    steps:
    # 1. 拉取代码
    - name: Checkout Repository
      uses: actions/checkout@v3

    # 2. 环境验证 (保持英文日志)
    - name: Verify Windows Environment
      shell: powershell
      run: |
        Write-Host "Step 1: Verifying OS Environment..."
        if ($env:OS -ne "Windows_NT") { throw "Error: Not a Windows machine!" }
        if (-not (Test-Path "C:\")) { throw "Error: C Drive not found!" }
        Write-Host "Success: Windows Server Environment Verified."

    # 3. 调用安装脚本 【注意路径变化】
    - name: Run Install Script
      shell: powershell
      # 以前是 .\install.ps1，现在指向 config 目录
      run: .\config\install-tinytex.ps1

    # 4. 编译 PDF 【关键修改：进入目录编译】
    - name: Compile PDF
      # 指定工作目录，这样 LaTeX 处理相对路径(如图片引用)时才不会报错
      working-directory: tex/demo
      run: xelatex -interaction=nonstopmode test2.tex

    # 5. 上传结果 【注意路径变化】
    - name: Upload Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: final-report
        # 编译产物会生成在 tex/demo 目录下
        path: tex/demo/test2.pdf